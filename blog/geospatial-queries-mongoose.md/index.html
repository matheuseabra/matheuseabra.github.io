<!DOCTYPE html><html lang="en"><meta charset="utf-8" /><meta content="IE=edge" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1" name="viewport" /><title> Geospatial queries with mongoose and TypeScript | Matheus Seabra</title><meta name="description" content="FullStack JavaScript Development" /><meta itemprop="name" content="Matheus Seabra" /><meta name="author" content="Matheus Seabra" /><meta itemprop="description" content="Avoiding Harvesine formula when calculating the distance between two points with mongoose&#39;s &lt;code&gt;$geometry&lt;/code&gt; and &lt;code&gt;$maxDistance&lt;/code&gt; operators." /><meta itemprop="image" content="https://my-image-hosting.s3.amazonaws.com/matheuseabra.me-blog/default-blog-image.png" /><meta property="og:url" content="https://matheuseabra.me/blog/geospatial-queries-mongoose.md/" /><meta content="website" property="og:type" /><meta property="og:title" content="Geospatial queries with mongoose and TypeScript | Matheus Seabra" /><meta property="og:site_name" content="Matheus Seabra" /><meta property="og:description" content="Avoiding Harvesine formula when calculating the distance between two points with mongoose&#39;s &lt;code&gt;$geometry&lt;/code&gt; and &lt;code&gt;$maxDistance&lt;/code&gt; operators." /><meta property="og:image" content="https://my-image-hosting.s3.amazonaws.com/matheuseabra.me-blog/default-blog-image.png" /><meta name="twitter:url" content="https://matheuseabra.me/blog/geospatial-queries-mongoose.md/" /><meta content="summary" name="twitter:card" /><meta name="twitter:title" content="Geospatial queries with mongoose and TypeScript | Matheus Seabra" /><meta name="twitter:site" content="Matheus Seabra" /><meta name="twitter:description" content="Avoiding Harvesine formula when calculating the distance between two points with mongoose&#39;s &lt;code&gt;$geometry&lt;/code&gt; and &lt;code&gt;$maxDistance&lt;/code&gt; operators." /><meta content="@matseabra" name="twitter:creator" /><meta property="twitter:image" content="https://my-image-hosting.s3.amazonaws.com/matheuseabra.me-blog/carbon+(1).png" /><meta name="twitter:image:width" content= "280" /><meta name="twitter:image:height" content= "480" /><link rel="icon" type="image/x-icon" href="/assets/images/fav.png" /><link rel="stylesheet" href="/assets/css/fonts.min.css" /><link rel="stylesheet" href="/assets/css/app.min.css" /><link rel="stylesheet" href="/assets/css/highlight.css" /><link rel="stylesheet" href="/assets/css/overides.css" /><link rel="alternate" type="application/rss+xml" title="Matheus Seabra" href="/feed.xml" /><link rel="canonical" href="/blog/geospatial-queries-mongoose.md/" /> <script src="https://code.iconify.design/1/1.0.7/iconify.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script> <script> hljs.initHighlightingOnLoad(); </script></head><div id="barba-wrapper"><div class="barba-container geospatial-queries-with-mongoose-and-typescript"><header class="header"> <a class="header__title" href="/">Matheus Seabra</a><nav><ul class="header__list"><li> <a class="header__link" href="/" data-anchor="projects">Work</a></li><li> <a class="header__link" href="/blog">Blog</a></li><li> <a class="header__link" href="/about">About</a></li><li> <a class="header__link" href="/resume">Resume</a></li><li> <a class="header__link" data-scroll href="#contact">Contact</a></li></ul></nav></header><header class="header--mobile"> <a class="header__title" href="/">Matheus Seabra</a><div class="hamburger"><div></div><div></div><div></div></div><nav class="header__nav"><ul class="header__list"><li> <a class="header__link" href="/" data-anchor="projects">Work</a></li><li> <a class="header__link" href="/blog">Blog</a></li><li> <a class="header__link" href="/about">About</a></li><li> <a class="header__link" data-scroll href="#contact">Contact</a></li></ul></nav></header><main><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><section class="mast bg-lightgrey rellax" data-rellax-speed="-4"><div class="grid"><div class="mast__container" style="text-align: left;"><h1 class="mast__title" style="text-align: left; margin: 0">Geospatial queries with mongoose and TypeScript</h1><br> <time class="mast__date black-stripe" datetime="2021-01-05T00:00:00+00:00" itemprop="datePublished">January 2021</time></div></div></section><section class="section-padding bg-white"><div class="grid-post"><div id="markdown" itemprop="articleBody"><h2 id="scenario">Scenario</h2><p>I was recently working on a problem where I needed to query messages based on a certain physical location.</p><p>To achieve that, a Haversine formula implementation is used to calculate the distance between two points using its latitude and longitude. However, we can solve this problem by query a schema using geospatial’s query feature from Mongoose.</p><h2 id="approach">Approach</h2><p>First, we need to declare a <code class="language-plaintext highlighter-rouge">MessageSchema</code> and what field should be used as <code class="language-plaintext highlighter-rouge">2dSphere</code>. Because I’m using TypeScript with Node, I have to define a document type in order to instantiate the model properly.</p><div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// message.model.ts</span>

<span class="k">import</span> <span class="nx">mongoose</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">MessageDocument</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Document</span> <span class="o">&amp;</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">text</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">location</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">type</span><span class="p">:</span> <span class="p">{</span> <span class="nl">type</span><span class="p">:</span> <span class="nb">String</span> <span class="p">};</span>
    <span class="nl">coordinates</span><span class="p">:</span> <span class="nb">Array</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">MessageSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span>
  <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">text</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">location</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span> <span class="p">},</span>
      <span class="na">coordinates</span><span class="p">:</span> <span class="nb">Array</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">timestamps</span><span class="p">:</span> <span class="p">{},</span>
  <span class="p">}</span>
<span class="p">);</span>

<span class="nx">MessageSchema</span><span class="p">.</span><span class="nx">index</span><span class="p">({</span> <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2dsphere</span><span class="dl">"</span> <span class="p">});</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="o">&lt;</span><span class="nx">MessageDocument</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">Message</span><span class="dl">"</span><span class="p">,</span> <span class="nx">MessageSchema</span><span class="p">);</span>
</code></pre></div></div><p>Once the model is defined, we can then query <code class="language-plaintext highlighter-rouge">Message</code> objects by latitude and longitude via the <code class="language-plaintext highlighter-rouge">$maxDistance</code> and <code class="language-plaintext highlighter-rouge">$geometry</code> MongoDB operators, passing the longitude and latitude as method parameters to the service:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// message.service.ts</span>

<span class="k">import</span> <span class="nx">Message</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../schemas/MessageSchema</span><span class="dl">"</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">IRequest</span> <span class="p">{</span>
  <span class="nl">latt</span><span class="p">:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nl">long</span><span class="p">:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">MessageService</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">messageSchema</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">messageSchema</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">async</span> <span class="nx">run</span><span class="p">({</span> <span class="nx">latt</span><span class="p">,</span> <span class="nx">long</span> <span class="p">}:</span><span class="nx">IRequest</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Message</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSchema</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
      <span class="na">location</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">$near</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">$maxDistance</span><span class="p">:</span> <span class="mi">15000</span><span class="p">,</span>
          <span class="na">$geometry</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Point</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">coordinates</span><span class="p">:</span> <span class="p">[</span><span class="nx">long</span><span class="p">,</span> <span class="nx">latt</span><span class="p">],</span>
          <span class="p">},</span>
        <span class="p">},</span>
      <span class="p">},</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">messages</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Now, <code class="language-plaintext highlighter-rouge">MessageService</code> is able to query messages by latitude and longitude instead of doing error-prone and compute-intensive math with the Haversine formula.</p><h2 id="takeaways">Takeaways</h2><p><strong>My takeaway from this is:</strong> don’t re-invent the wheels. Use tools that are going to make you solve problems faster.</p></div><div class="social-share black-stripe"> <b>Share on social media:</b><ul><li><a class="social-icon" href="https://twitter.com/intent/tweet?text=Geospatial queries with mongoose and TypeScript&url=https://matheuseabra.me/blog/geospatial-queries-mongoose.md/&via=matseabra&related=matseabra" rel="nofollow" target="_blank" title="Share on Twitter"><span class="iconify" data-icon="mdi:twitter"></span></a></li><li> <a class="social-icon" href="https://facebook.com/sharer.php?u=https://matheuseabra.me/blog/geospatial-queries-mongoose.md/" rel="nofollow" target="_blank" title="Share on Facebook"><span class="iconify" data-icon="mdi:facebook"></span></a></li><li> <a class="social-icon" href="http://www.linkedin.com/shareArticle?mini=true&url=https://matheuseabra.me&title=Matheus Seabra&summary=FullStack JavaScript Development&source=https://matheuseabra.me"><span class="iconify" data-icon="mdi:linkedin"></span></a></li><li> <a class="social-icon" href="http://www.reddit.com/submit?url=https://matheuseabra.me&title=Matheus Seabra"> <span class="iconify" data-icon="mdi:reddit"></span> </a></li></ul></div><style> .social-share { display: flex; flex-direction: column; align-items: flex-start; padding: 10px 20px; font-size: 1.2em; margin: 20px 0; } .social-share ul { display: inline-flex; list-style: none; margin-top: 10px; } .social-share li:first-child { margin-left: 0px; } .social-share li { margin-right: 10px; } .social-icon { color: white; }</style><div class="author-wrapper"><h3 class="black-stripe">About the author</h3><div class="author-container"> <img class="avatar-circle" src="/assets/images/matheus.jpg" alt=""><div class="author-description"><p>Matheus Seabra is a software engineer, writer, musician, and ex-failed-startup co-founder of CastleDev. He writes about software design and architecture best practices with FullStack JavaScript and is especially passionate about Domain-Driven Design, React and Enterprise Node.js with TypeScript.</p></div></div></div></div></section></article><section id="newsletter" class="work section-padding bg-lightgrey"><div class="grid newsletter-container"><h2 class="work__title black-stripe"> <span data-aos="slice-up" data-aos-duration="400">Subscribe to newsletter</span></h2><h3 class="newsletter-description"> Interested in how to write professional Full Stack JavaScript applications?<br>Subscribe to my newsletter to be notified of new content &#x1F525; <br> No spams. Unsubscribe anytime. 🖖</h3><form action="https://matheuseabra.us7.list-manage.com/subscribe/post?u=0ada142f3d6af9716322c4b2e&amp;id=7901c8363c" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate><div> <input type="email" value="" name="email" class="newsletter-input" id="mce-EMAIL" placeholder="Your best email" required> <button class="subscribe-button" type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe">Subscribe <span class="iconify" data-icon="feather:chevron-right" data-inline="false"></span></button></div><div id="mcs="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div><div style="display: none;" aria-hidden="true"> <input type="text" name="b_0ada142f3d6af9716322c4b2e_7901c8363c" tabindex="-1" value=""></div></form></div></section></main><footer id="contact" class="footer bg-black"><div class="grid"> <a class="footer__contact" href="/contact/">Let's connect</a><p style="color: white; margin: 20px 0 0 0;" class="footer__paragraph">Wow you’ve come this far, send me an <a class="footer__link" href="mailto:matheusvieiracoelho@gmail.com">email</a> or let's chat on <a class="footer__link" href="http://twitter.com/matseabra" target="_blank">Twitter</a>.</p></div><ul class="footer__list"><li> <a class="icon-footer" href="https://matheuseabra.me/downloads/Matheus-Seabra-Resume.pdf" target="_blank"><span class="iconify" data-icon="mdi:file-document"></span></a></li><li> <a class="icon-footer" href="https://www.linkedin.com/in/matheus-seabra-080ab3b7/" target="_blank"><span class="iconify" data-icon="mdi:linkedin"></span></a></li><li> <a class="icon-footer" href="https://github.com/matheuseabra" target="_blank"><span class="iconify" data-icon="mdi:github"></span></a></li><li> <a class="icon-footer" href="http://twitter.com/matseabra" target="_blank"><span class="iconify" data-icon="mdi:twitter"></span></a></li></ul></footer></div></div><div class="transition transition-in"></div><script src="/assets/js/jquery.min.js"></script> <script src="/assets/js/app.min.js"></script></body></html>
  